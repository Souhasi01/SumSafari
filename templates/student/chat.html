{% extends "base.html" %}
{% block title %}Chat â€” SumSafari{% endblock %}

{% block content %}
<style>
    .chat-container {
        max-width: 900px;
        margin: 40px auto;
        background: var(--soft-cream);
        border-radius: 20px;
        padding: 20px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.15);
    }

    .chat-box {
        height: 450px;
        overflow-y: auto;
        padding: 15px;
        border-radius: 15px;
        background: white;
        border: 2px solid #ececec;
    }

    .msg {
        margin-bottom: 18px;
        padding: 12px 16px;
        border-radius: 15px;
        max-width: 75%;
        line-height: 1.4;
    }

    .user-msg {
        background: #c9fdd7;
        margin-left: auto;
        border-bottom-right-radius: 5px;
    }

    .ai-msg {
        background: #f1f1f1;
        border-bottom-left-radius: 5px;
    }

    .msg-avatar {
        width: 45px;
        margin-right: 10px;
    }

    .tambo-wrapper {
        display: flex;
        align-items: flex-start;
    }

    #chat-form input {
        border-radius: 15px;
        padding: 12px 18px;
    }

    #send-btn {
        background-color: var(--jungle-green);
        color: white;
        border-radius: 12px;
        padding: 10px 25px;
        border: none;
    }
    #send-btn:hover {
        opacity: 0.85;
    }
</style>

<div class="chat-container">
    <h2 class="text-center mb-4" style="color: var(--jungle-green);">
        ðŸ¦“ Chat with TAMBO â€” Your AI Math Tutor
    </h2>

    <div id="chat-box" class="chat-box"></div>

    <form id="chat-form" class="mt-4 d-flex gap-3">
        <input type="text" id="message" class="form-control"
               placeholder="Ask Tambo a PSAC math question here..."
               autocomplete="off"
               required>

        <button type="submit" id="send-btn">Send</button>
    </form>
</div>

<script>
    const chatBox = document.getElementById("chat-box");

    function addMessage(text, sender) {
        const msg = document.createElement("div");

        if (sender === "ai") {
            msg.classList.add("tambo-wrapper");

            msg.innerHTML = `
                <img src="/static/images/zebrahead.png" class="msg-avatar">
                <div class="msg ai-msg">${text}</div>
            `;
        } else {
            msg.innerHTML = `<div class="msg user-msg">${text}</div>`;
        }

        chatBox.appendChild(msg);
        chatBox.scrollTop = chatBox.scrollHeight;
    }

    // Load previous chat history
    async function loadHistory() {
        const res = await fetch("/chat/history");
        const history = await res.json();

        history.forEach(m => {
            addMessage(m.text, m.sender);
        });
    }

    // Load history when page opens
    loadHistory();

    document.getElementById("chat-form").addEventListener("submit", async function(e) {
        e.preventDefault();

        const text = document.getElementById("message").value.trim();
        if (!text) return;

        addMessage(text, "user");
        document.getElementById("message").value = "";

        try {
            const res = await fetch("/chat/send", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ message: text })
            });

            const data = await res.json();
            addMessage(data.reply, "ai");

        } catch (err) {
            addMessage("Oops! Tambo cannot respond right now.", "ai");
        }
    });
</script>

{% endblock %}
